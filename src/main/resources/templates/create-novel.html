<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Fiction | 새 소설 쓰기</title>
    <!-- 외부 스타일시트 링크 -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/create-novel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>

    <!-- 메인 헤더 -->
    <div th:replace="~{fragments/mainHeader :: mainHeader}"></div>

    <!-- 메인 콘텐츠 영역 -->
    <main class="container create-novel-container">
        <section class="create-novel-section">
            <h2>새 소설 쓰기</h2>
            <form id="createNovelForm">
                <!-- 소설 제목 -->
                <div class="form-group">
                    <label for="novel-title">소설 제목</label>
                    <input type="text" id="novel-title" name="title" required>
                </div>

                <!-- 시놉시스 -->
                <div class="form-group">
                    <label for="novel-synopsis">시놉시스 (줄거리)</label>
                    <textarea id="novel-synopsis" name="synopsis" rows="6" placeholder="소설의 간략한 줄거리를 입력해주세요." required></textarea>
                </div>

                <!-- 장르 선택 및 추가 -->
                <div class="form-group">
                    <label for="novel-genres-input">장르 선택 및 추가 (최대 3개)</label>
                    <div class="genre-input-wrapper">
                        <input type="text" id="novel-genres-input" list="genre-options" placeholder="장르를 검색하거나 직접 입력하세요">
                        <datalist id="genre-options">
                            <!-- 장르 목록은 JS로 동적으로 채워집니다. -->
                        </datalist>
                    </div>
                    <div id="selected-genres" class="selected-genres-list">
                        <!-- 선택된 장르 태그들이 여기에 추가됩니다. -->
                    </div>
                </div>

                <!-- 소설 표지 이미지 -->
                <div class="form-group">
                    <label for="cover-image">소설 표지 이미지</label>
                    <input type="file" id="cover-image" name="coverImage">
                </div>

                <!-- 소설 내용 (1화) -->
                <div class="form-group">
                    <div class="novel-content-header">
                        <label for="novel-content">소설 내용 (1화)</label>
                        <button type="button" class="btn-ai-help">
                            <i class="fas fa-magic"></i> AI 와 함께쓰기
                        </button>
                    </div>
                    <textarea id="novel-content" name="content" rows="15" placeholder="디폴트로 1화당 글자수는 5000자 까지 가능합니다." required></textarea>
                </div>


                <button type="submit" class="btn btn-submit">소설 생성하기</button>
            </form>
        </section>
    </main>

    <!-- 메인 푸터 -->
    <div th:replace="~{fragments/mainFooter :: mainFooter}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('createNovelForm');
            const genresInput = document.getElementById('novel-genres-input');
            const genreOptions = document.getElementById('genre-options');
            const selectedGenresContainer = document.getElementById('selected-genres');

            let allGenres = []; // DB에서 가져온 모든 장르 목록
            let selectedGenreIds = new Set(); // 선택된 장르 ID를 추적

            // DB에서 장르 목록을 가져와 datalist 채우기
            async function fetchGenres() {
                try {
                    const url = new URL('/api/genres', window.location.origin);
                    const response = await fetch(url.toString());
                    if (response.ok) {
                        allGenres = await response.json();
                        allGenres.forEach(genre => {
                            const option = document.createElement('option');
                            option.value = genre.name;
                            genreOptions.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching genres:', error);
                }
            }

            // 장르 추가 (태그 생성)
            async function addGenre(genreName) {
                if (selectedGenreIds.size >= 3) {
                    alert('장르는 최대 3개까지만 선택할 수 있습니다.');
                    genresInput.value = '';
                    return;
                }

                const existingGenre = allGenres.find(g => g.name === genreName);
                let genreId;

                if (existingGenre) {
                    genreId = existingGenre.genre_id;
                } else {
                    try {
                        const url = new URL('/api/genres', window.location.origin);
                        const response = await fetch(url.toString(), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: genreName })
                        });
                        if (response.ok) {
                            const newGenre = await response.json();
                            genreId = newGenre.genre_id;
                            allGenres.push(newGenre);

                            const option = document.createElement('option');
                            option.value = newGenre.name;
                            genreOptions.appendChild(option);

                            alert(`새로운 장르 '${newGenre.name}'가 추가되었습니다.`);
                        } else {
                            const error = await response.json();
                            alert('장르 추가 실패: ' + (error.message || '알 수 없는 오류'));
                            return;
                        }
                    } catch (error) {
                        console.error('Error adding new genre:', error);
                        alert('네트워크 오류가 발생했습니다.');
                        return;
                    }
                }

                // 이미 선택된 장르인지 확인
                if (selectedGenreIds.has(genreId)) {
                    alert('이미 선택된 장르입니다.');
                    genresInput.value = '';
                    return;
                }

                selectedGenreIds.add(genreId);

                // 장르 태그 생성 및 추가
                const genreTag = document.createElement('span');
                genreTag.className = 'genre-tag';
                genreTag.innerHTML = `
                    ${genreName}
                    <i class="fas fa-times-circle remove-tag-btn"></i>
                `;
                genreTag.dataset.id = genreId;

                genreTag.querySelector('.remove-tag-btn').addEventListener('click', () => {
                    selectedGenreIds.delete(parseInt(genreTag.dataset.id));
                    genreTag.remove();
                });

                selectedGenresContainer.appendChild(genreTag);
                genresInput.value = '';
            }

            // Enter 키 또는 선택 시 장르 추가
            genresInput.addEventListener('change', () => {
                const genreName = genresInput.value.trim();
                if (genreName) {
                    addGenre(genreName);
                }
            });

            // 폼 제출 시 API 호출
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const data = {
                    title: formData.get('title'),
                    synopsis: formData.get('synopsis'),
                    content: formData.get('content'), // 소설 내용 필드 추가
                    coverImageUrl: formData.get('coverImage').name || null,
                    genreIds: Array.from(selectedGenreIds)
                };

                try {
                    const url = new URL('/api/novels', window.location.origin);
                    const response = await fetch(url.toString(), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': 'Bearer YOUR_AUTH_TOKEN'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert('소설이 성공적으로 생성되었습니다!');
                        window.location.href = `/novels/${result.novelId}`;
                    } else {
                        const error = await response.json();
                        alert('소설 생성 실패: ' + (error.message || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('네트워크 오류:', error);
                    alert('네트워크 오류가 발생했습니다.');
                }
            });

            // 페이지 로드 시 장르 목록 가져오기
            fetchGenres();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Fiction | 새 소설 쓰기</title>
    <!-- Tailwind CSS (대신) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
            color: #1f2937;
        }

        .create-novel-container {
            max-width: 960px;
            margin: 0 auto;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .create-novel-section {
            width: 100%;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .create-novel-section h2 {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group input[type="password"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #1f2937;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .form-group textarea {
            resize: vertical;
        }

        .genre-input-wrapper {
            position: relative;
            width: 100%;
        }

        .selected-genres-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        .genre-tag {
            display: flex;
            align-items: center;
            background-color: #4f46e5;
            color: #fff;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            gap: 0.25rem;
        }

        .genre-tag .remove-tag-btn {
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .genre-tag .remove-tag-btn:hover {
            opacity: 1;
        }

        .btn-submit {
            display: block;
            width: 100%;
            padding: 1rem;
            background-color: #4f46e5;
            color: #fff;
            font-size: 1.125rem;
            font-weight: bold;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .btn-submit:hover {
            background-color: #4338ca;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .create-novel-section {
                padding: 1rem;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>

    <!-- Main Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-indigo-600">Vibe Fiction</a>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition duration-300">소설 탐색</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-indigo-600 font-medium transition duration-300">내 소설</a></li>
                    <li><a href="#" class="bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-700 transition duration-300">로그인</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="create-novel-container">
        <section class="create-novel-section">
            <h2>새 소설 쓰기</h2>
            <form id="createNovelForm">
                <!-- 소설 제목 -->
                <div class="form-group">
                    <label for="novel-title">소설 제목</label>
                    <input type="text" id="novel-title" name="title" required>
                </div>

                <!-- 시놉시스 -->
                <div class="form-group">
                    <label for="novel-synopsis">시놉시스 (줄거리)</label>
                    <textarea id="novel-synopsis" name="synopsis" rows="6" placeholder="소설의 간략한 줄거리를 입력해주세요." required></textarea>
                </div>

                <!-- 장르 선택 및 추가 -->
                <div class="form-group">
                    <label for="novel-genres-input">장르 선택 및 추가 (최대 3개)</label>
                    <div class="genre-input-wrapper">
                        <input type="text" id="novel-genres-input" list="genre-options" placeholder="장르를 검색하거나 직접 입력하세요">
                        <datalist id="genre-options">
                            <!-- 장르 목록은 JS로 동적으로 채워집니다. -->
                        </datalist>
                    </div>
                    <div id="selected-genres" class="selected-genres-list">
                        <!-- 선택된 장르 태그들이 여기에 추가됩니다. -->
                    </div>
                </div>

                <!-- 소설 표지 이미지 -->
                <div class="form-group">
                    <label for="cover-image">소설 표지 이미지</label>
                    <input type="file" id="cover-image" name="coverImage">
                </div>

                <!-- 소설 내용 (1화) -->
                <div class="form-group">
                    <label for="novel-content">소설 내용 (1화)</label>
                    <textarea id="novel-content" name="content" rows="15" placeholder="디폴트로 1화당 글자수는 5000자 까지 가능합니다." required></textarea>
                </div>


                <button type="submit" class="btn btn-submit">소설 생성하기</button>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2025 Vibe Fiction. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('createNovelForm');
            const genresInput = document.getElementById('novel-genres-input');
            const genreOptions = document.getElementById('genre-options');
            const selectedGenresContainer = document.getElementById('selected-genres');

            let allGenres = []; // DB에서 가져온 모든 장르 목록
            let selectedGenreIds = new Set(); // 선택된 장르 ID를 추적

            // DB에서 장르 목록을 가져와 datalist 채우기
            async function fetchGenres() {
                try {
                    const url = new URL('/api/genres', window.location.origin);
                    const response = await fetch(url.toString());
                    if (response.ok) {
                        allGenres = await response.json();
                        allGenres.forEach(genre => {
                            const option = document.createElement('option');
                            option.value = genre.name;
                            genreOptions.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching genres:', error);
                }
            }

            // 장르 추가 (태그 생성)
            async function addGenre(genreName) {
                if (selectedGenreIds.size >= 3) {
                    alert('장르는 최대 3개까지만 선택할 수 있습니다.');
                    genresInput.value = '';
                    return;
                }

                const existingGenre = allGenres.find(g => g.name === genreName);
                let genreId;

                if (existingGenre) {
                    genreId = existingGenre.genre_id;
                } else {
                    try {
                        const url = new URL('/api/genres', window.location.origin);
                        const response = await fetch(url.toString(), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: genreName })
                        });
                        if (response.ok) {
                            const newGenre = await response.json();
                            genreId = newGenre.genre_id;
                            allGenres.push(newGenre);

                            const option = document.createElement('option');
                            option.value = newGenre.name;
                            genreOptions.appendChild(option);

                            alert(`새로운 장르 '${newGenre.name}'가 추가되었습니다.`);
                        } else {
                            const error = await response.json();
                            alert('장르 추가 실패: ' + (error.message || '알 수 없는 오류'));
                            return;
                        }
                    } catch (error) {
                        console.error('Error adding new genre:', error);
                        alert('네트워크 오류가 발생했습니다.');
                        return;
                    }
                }

                // 이미 선택된 장르인지 확인
                if (selectedGenreIds.has(genreId)) {
                    alert('이미 선택된 장르입니다.');
                    genresInput.value = '';
                    return;
                }

                selectedGenreIds.add(genreId);

                // 장르 태그 생성 및 추가
                const genreTag = document.createElement('span');
                genreTag.className = 'genre-tag';
                genreTag.innerHTML = `
                    ${genreName}
                    <i class="fas fa-times-circle remove-tag-btn"></i>
                `;
                genreTag.dataset.id = genreId;

                genreTag.querySelector('.remove-tag-btn').addEventListener('click', () => {
                    selectedGenreIds.delete(parseInt(genreTag.dataset.id));
                    genreTag.remove();
                });

                selectedGenresContainer.appendChild(genreTag);
                genresInput.value = '';
            }

            // Enter 키 또는 선택 시 장르 추가
            genresInput.addEventListener('change', () => {
                const genreName = genresInput.value.trim();
                if (genreName) {
                    addGenre(genreName);
                }
            });

            // 폼 제출 시 API 호출
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const data = {
                    title: formData.get('title'),
                    synopsis: formData.get('synopsis'),
                    content: formData.get('content'), // 소설 내용 필드 추가
                    coverImageUrl: formData.get('coverImage').name || null,
                    genreIds: Array.from(selectedGenreIds)
                };

                try {
                    const url = new URL('/api/novels', window.location.origin);
                    const response = await fetch(url.toString(), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': 'Bearer YOUR_AUTH_TOKEN'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert('소설이 성공적으로 생성되었습니다!');
                        window.location.href = `/novels/${result.novelId}`;
                    } else {
                        const error = await response.json();
                        alert('소설 생성 실패: ' + (error.message || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('네트워크 오류:', error);
                    alert('네트워크 오류가 발생했습니다.');
                }
            });

            // 페이지 로드 시 장르 목록 가져오기
            fetchGenres();
        });
    </script>
</body>
</html>

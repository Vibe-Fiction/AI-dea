# 트러블슈팅: 장르 관리 리팩토링 및 Enum 적용 과정

본 문서는 **Team Ai-dea**의 **Vibe Fiction 프로젝트**(Relai 플랫폼)에서 장르 관리 방식을 개선하는 과정에서 논의된 여러 접근 방식과, 그 과정에서 발생한 **트러블슈팅**, 그리고 최종적으로 채택된 **설계 결정**을 기록한 기술 문서입니다.

**작성자:** [왕택준](https://github.com/TJK98)

**작성일:** 2025년 8월 14일

---

## 1. 문제 배경 및 목표

* **기존 문제점**

  * `Genres` 테이블의 `name` 컬럼이 `VARCHAR`(문자열)로 정의되어 있었음.
  * 이로 인해 `"판타지"`와 `"판타시"`처럼 비표준 데이터가 입력될 가능성이 존재.
  * 데이터 정합성이 깨지고, 장르 기반 검색/분류 기능 구현 시 오류가 발생할 위험이 있음.

* **핵심 목표**

  * 장르를 **Enum 타입**으로 코드 레벨에서 관리.
  * DB 차원에서도 타입 안정성을 확보하여 데이터 정합성을 보장.

---

## 2. 시도했던 접근 방식과 트러블슈팅

### 2-1. 접근 방식 1: `@ElementCollection`을 활용한 구조 변경

* **시도 내용**:
  `Genres`와 `NovelGenres` 엔티티를 제거하고, `Novels` 엔티티가 `Set<Genre>` Enum 컬렉션을 `@ElementCollection`으로 직접 관리하도록 변경.

* **기대 효과**:
  엔티티/테이블 구조 단순화 → 코드 복잡도 감소.

* **문제 발생 (Troubleshooting)**:

  * 실행 시 예외:

    ```text
    Field 'genre_id' doesn't have a default value
    ```
  * 원인: `ddl-auto: update` 옵션은 기존 테이블 구조를 파괴적으로 변경하지 않음.
    → 기존 스키마와 애플리케이션이 기대하는 스키마 충돌 발생.

* **결론**:

  * 기존 N\:M 구조를 완전히 버려야 하고, 팀원 전원이 DB 스키마를 정리해야 하는 등 협업 비용이 너무 큼.
  * **폐기** 결정.

---

### 2-2. 접근 방식 2: 별도의 `Genre.java` Enum 파일 생성

* **시도 내용**:
  `Genre.java`를 독립된 Enum 파일로 두고 여러 엔티티에서 공통 사용.

* **논의 결과**:

  * `Genres` 엔티티와 `Genre` Enum 간의 관계가 모호해질 수 있음.
  * 중복된 개념으로 관리 포인트가 늘어난다는 단점.

---

## 3. 최종 해결책: 기존 엔티티 구조 유지 + Enum 타입 적용

**원칙**: *“안정적인 연관관계 구조는 유지하면서, 타입 안정성만 확보하자”*

1. **`Genres` 엔티티 내부에 Enum 정의**

   * `Genres.java` 안에 `public enum GenreType` 정의.
   * 장르 관련 정의를 한 파일에 모아 응집도 향상.

2. **필드 타입 변경**

   * `private String name;` → `@Enumerated(EnumType.STRING) private GenreType name;`

3. **DB 스키마 자동 업데이트**

   * `ddl-auto: update` 설정을 활용, Hibernate가 `name` 컬럼을 `VARCHAR` → `ENUM(...)`으로 자동 변경.

4. **DTO/서비스 로직 수정**

   * DTO(`NovelCreateRequestTj`)는 장르 ID 대신 문자열(`"FANTASY"`) 배열을 받음.
   * Service(`NovelServiceTj`)는 DTO로 받은 문자열을 `GenreType` Enum으로 변환 → 유효성 검증 → `genresRepository.findByNameIn(...)`으로 조회.

---

## 4. 결론 및 배운 점

* **문제 요약**: 자유로운 문자열 입력으로 인한 데이터 정합성 문제.

* **해결책**: 기존 N\:M 연관관계 구조는 유지하고, 핵심 필드 타입만 **Enum**으로 교체 → 최소한의 변경으로 타입 안정성과 데이터 정합성 확보.

* **교훈**:

  1. 리팩토링 시 “이상적인 설계”만 추구하면 협업 비용이 폭증할 수 있음. → **점진적이고 실용적인 개선**이 중요.
  2. JPA `ddl-auto: update` 옵션은 컬럼 삭제/구조 파괴를 지원하지 않음. 대규모 변경이 필요한 경우 **명시적 DB 마이그레이션**이 필요함.

---

> 본 문서는 Vibe Fiction 프로젝트(Relai 플랫폼) 개발 과정에서 **Enum 기반 장르 관리 체계**를 도입하는 과정에서의 시도, 실패, 그리고 최종 의사결정을 정리한 리팩토링 사례입니다.
